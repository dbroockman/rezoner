---
title: "pdev_sf_rhna6"
author: Broockman, Damerdji
output: html_document
date: "2023-11-23"
---

This R Markdown file recreates STATA code to estimate the expected # of units that will be built in RHNA6. Per program X of the housing element, this file San Francisco's model for the likelihood of development.

```{r, include=FALSE}
library(readr)
library(readxl)
library(dplyr)
library(tidyr)
library(modelr)
library(caret)
library(sf)
```

```{r}
# This should have no effect, but it's here just in case at some point
# non-deterministic code is added to this Rmd file
set.seed(0)

# years of rhna cycle after rezoning
n_years <- 5

```

Create two dataframes, one with the history of SF housing production (courtesy of Blue Sky) and another with the RHNA6 site inventory.

```{r read_data, include=F}
#sf_history <- read_csv("./Blue Sky Code and Inputs/SF_Logistic_Data.csv")

sf_history <- st_read('./geobluesky.geojson')
#sf_history <- select(sf_history, -mapblklot)
#sf_sites_inventory <- rmapshaper::ms_simplify(sf_sites_inventory, keep=0.1)
sf_history <- dplyr::relocate(sf_history, geometry)

sf_sites_inventory <- st_read('./Fall2023Rezoning.json')
sf_sites_inventory <- dplyr::relocate(sf_sites_inventory, geometry)

sf_sites_inventory <- sf_sites_inventory %>%
  rename(M3_ZONING = HeightText) %>%
  rename(height = HeightInteger) %>%
  mutate(ACRES = Shape__Area / 43560)
  
#sf_sites_inventory <- read_excel("./sf-sites-inventory-form-Dec-2022 - Copy.xlsx", 
#                                 sheet = "Table B -Submitted-Dec-22", 
#                                 skip=1, 
#                                 na='n/a')
```

Expected units if developed is an overestimate because it does not account for existing number of units that are demo'd.

The first thing we do is recreate the Blue Sky logistic regression model
```{r model}
model <- readRDS('light_model.rds')
```



```{r join}
# Why are there duplicative mapblklot_masters? And does this affect our results?
# It's possible we need to first do a groupby on mapblklot and sum up density
# TODO: fix this so i dont lose ~3k parcels. add geo join as backup?
sf_sites_inventory <- sf_sites_inventory %>%
  mutate(MapBlkLot_Master = stringr::str_replace(mapblklot, "-", ""),
         year = 2016) %>%
  distinct(MapBlkLot_Master, .keep_all = TRUE) %>%
  st_drop_geometry() %>%
  inner_join(filter(sf_history, year == 2016), 
             by = c('MapBlkLot_Master', "year"))


# We are setting all those heights to 20'
# TODO: I should double-check this height is correct.
height_setter <- function(M3_ZONING, height) {
  dplyr::case_when(
    !is.na(M3_ZONING) & is.na(height) ~ 40,
    .default = height
    )
}
```

David, can you confirm that 20' heights are the right default value to set for parcels where fourplexes are permitted - or where the city is apply density decontrol without height change. On the interactive map, it looks like the Existing Permitted Height is 40-X, which seems to permit 40' https://experience.arcgis.com/experience/6e0e399f9c82456dbda233eacebc433d/?data_id=dataSource_3-18a6c71b7cb-layer-4%3A11875

### Potential Rezonings

I implement various ways of augmenting the Map 3 rezoning so we can get closer to our target.

```{r}

fourplex <- "Increased density up to four units (six units on corner lots)"
decontrol <- "No height change, density decontrol"
skyscrapers <-  "300' Height Allowed"
parisian <- function(df) {
  # Find all M3_ZONING with fourplex and set to 55'
  parisian <- "55' Height Allowed"
  df[(!is.na(df$M3_ZONING)) & df$M3_ZONING == fourplex, 'M3_ZONING'] <- parisian
  df[(!is.na(df$M3_ZONING)) & df$M3_ZONING == decontrol, 'M3_ZONING'] <- parisian
  df
}

legalize_it <- function(df) {
    df[, 'M3_ZONING'] <- skyscrapers
    df
}


upzone <- function(df) {
  # Given site inventory df inner joined with history 
  # Control upzoning by changing M3_ZONING before passing df in
  # Return df with fields "Expected" and "Pdev"
  df <- select(sf_sites_inventory, -'mapblklot.y', -'mapblklot.x')
  df <- st_drop_geometry(df)
  # Erase existing zoning indicators for rezoned parcels
  n_col_si <- ncol(df)
  (zoning_cols <- colnames(df)[(n_col_si-7):n_col_si])
  df[!(is.na(df$M3_ZONING) | grepl("Unchanged", df$M3_ZONING)), zoning_cols] <- 0
  
  # So I don't have to handle missing values
  df[is.na(df$M3_ZONING), 'M3_ZONING'] <- 'Unchanged'
  
  # See page 30 of Appendix B in Scenario A for reasoning
  df <- df %>%
    mutate(zp_FormBasedMulti = if_else(!(grepl("Unchanged", M3_ZONING) | M3_ZONING == fourplex),
                                       1,
                                       zp_FormBasedMulti))
  
  #df <- df[!grepl("Unchanged", df$M3_ZONING), ]
  df <- df %>%
    mutate(zp_DensRestMulti = if_else(M3_ZONING == fourplex | grepl("Unchanged", M3_ZONING), 1, zp_DensRestMulti)) %>%
    mutate(height = as.numeric(stringr::str_extract(M3_ZONING, "\\d+"))) %>%
    mutate(height = height_setter(M3_ZONING, height)) %>%
    mutate(
    # Calculate envelope_1000_new based on ACRES and height
    Envelope_1000_new = case_when(
      ACRES < 1 ~ ((ACRES * 43560) * 0.75 * height / 10.5) / 1000,
      ACRES >= 1 & height < 85 ~ ((ACRES * 43560) * 0.55 * height / 10.5) / 1000,
      height >= 85 ~ ((ACRES * 43560) * 0.8 * height / 10.5) / 1000,
      TRUE ~ NA_real_
    ),
    existing_sqft = Envelope_1000 / Upzone_Ratio,
    Upzone_Ratio_new = Envelope_1000_new / existing_sqft
  ) %>%
  mutate(
    Envelope_1000 = if_else(!grepl("Unchanged", M3_ZONING), Envelope_1000_new, Envelope_1000),
    Upzone_Ratio = if_else(!grepl("Unchanged", M3_ZONING), Upzone_Ratio_new, Upzone_Ratio)
  )
  
  predictions.16 <- predict(model, newdata = df, type = "response")

  df <- df %>%
    mutate(expected_units_if_dev = Envelope_1000 * 1000 * 0.8 / 850, 0) %>%
   # mutate(M3_CAP = abs(M3_CAP)) %>%
  #  mutate(du_allowed = ACRES * M3_MAXDENS) %>%
  #  mutate(expected_units_if_dev = ifelse((!is.na(du_allowed)) & (expected_units_if_dev > du_allowed),
  #                                      du_allowed, expected_units_if_dev)) %>%
    mutate(pdev = 1 - (1-predictions.16)^n_years) %>% 
    mutate(expected_units = pdev * expected_units_if_dev)

  print('expected units')
  print(summary(df$expected_units))
  print('pdev')
  print(summary(df$pdev))
  print('E[u | d]')
  print(summary(df$expected_units_if_dev))
  #print(df %>% filter(expected_units > 22))
  return(df)
  #(total_expected_units <- sum(df$expected_units, na.rm=T))
}

#upzone(legalize_it(sf_sites_inventory))
#upzone(parisian(sf_sites_inventory))
#upzone(union_of_maxdens(sf_sites_inventory))
result <- upzone(sf_sites_inventory)
sum(result$expected_units)
```


We eventually will need to subtract the capacity that's existing. That's what this dataframe is for.
```{r}
sf_sites_inventory_norezoning <- sf_sites_inventory
```


Now let's prepare the sites inventory df so the blue sky model can predict the Pdev given its upzoning
```{r reset_zp}
n_col_si <- ncol(sf_sites_inventory)
(zoning_cols <- colnames(sf_sites_inventory)[(n_col_si-7):n_col_si])
sf_sites_inventory[!is.na(sf_sites_inventory$M3_ZONING), zoning_cols] <- 0
```

```{r}
fourplex <- "Increased density up to four units (six units on corner lots)"

sf_sites_inventory[is.na(sf_sites_inventory$M3_ZONING), 'M3_ZONING'] <- 'No Change'
sf_sites_inventory <- sf_sites_inventory %>%
  mutate(zp_FormBasedMulti = if_else(!(M3_ZONING == 'No Change' | M3_ZONING == fourplex),
                                     1,
                                     zp_FormBasedMulti))
sf_sites_inventory <- sf_sites_inventory %>%
  mutate(zp_DensRestMulti = if_else(M3_ZONING == fourplex, 1, zp_DensRestMulti))

print(zoning_cols)
mean(rowSums(st_drop_geometry(sf_sites_inventory[zoning_cols])) > 0)
```

### Feature Engineering

Create a height variable from Map 3 Zoning.

```{r}
# First we extract the numeric height where possible,
table(sf_sites_inventory$M3_ZONING)
table(as.numeric(stringr::str_extract(sf_sites_inventory$M3_ZONING, "\\d+")))

# But as the above table shows, the above operation fails to account for
# 1) Added height in existing form-based area, 2) fourplex zoning, and 3) 
# density decontrol
sf_sites_inventory <- sf_sites_inventory %>%
  mutate(height = as.numeric(stringr::str_extract(M3_ZONING, "\\d+")))

sf_sites_inventory <- mutate(sf_sites_inventory, height = height_setter(M3_ZONING, height))
```

Appendix B Page 33 on Map 3:
- 56,101 parcels rezoned to form-based density without height increase
- 12,542 parcels rezoned to form-based density with height increase



Doing legwork so we can caluclate the expected units if developed
```{r}
sf_sites_inventory <- sf_sites_inventory %>%
  mutate(
    # Calculate envelope_1000_new based on ACRES and height
    Envelope_1000_new = case_when(
      ACRES < 1 ~ ((ACRES * 43560) * 0.75 * height / 10.5) / 1000,
      ACRES >= 1 & height < 85 ~ ((ACRES * 43560) * 0.55 * height / 10.5) / 1000,
      height >= 85 ~ ((ACRES * 43560) * 0.8 * height / 10.5) / 1000,
      TRUE ~ NA_real_
    ),
    existing_sqft = Envelope_1000 / Upzone_Ratio,
    Upzone_Ratio_new = Envelope_1000_new / existing_sqft
  ) %>%
  mutate(
    Envelope_1000 = if_else(!(M3_ZONING == 'No Change'), Envelope_1000_new, Envelope_1000),
    Upzone_Ratio = if_else(!(M3_ZONING == 'No Change'), Upzone_Ratio_new, Upzone_Ratio)
  )
```

Updating the probability of development of sites based on the rezoning:

```{r}
# Fed Reserve rate pulled from here: https://fred.stlouisfed.org/series/DFII10
# Zillow price pulled from here: https://www.zillow.com/home-values/20330/san-francisco-ca/
# TODO: Double-check those sources give same answers for 2016 as sf_history indicates

predictions.16 <- predict(model, newdata = sf_sites_inventory, type = "response")

sf_sites_inventory.23 <- sf_sites_inventory %>%
  mutate(
    year = 2023,
    Const_FedReserve_Real = 102.16,
    Zillow_Price_Real = 1.254436 
    # I rescaled the true value 1,254,436  by letting unit be in millions but I suspect SF did different caling
  )

predictions.23 <- predict(model, newdata = sf_sites_inventory.23, type = "response")

```

We also calculate the existing pdev of sites

```{r}
predictions.16.no.rezone <- predict(model, newdata = sf_sites_inventory_norezoning, type = "response")

```

Sanity check that upzoning increases pdev
```{r}
summary(predictions.16.no.rezone)
summary(predictions.16)
```

Now to finish computing expected units under status quo zoning

```{r}
sf_sites_inventory_norezoning <- sf_sites_inventory_norezoning %>%
  mutate(expected_units_if_dev = ifelse(M3_ZONING != 'No Change', 
                                        Envelope_1000 * 1000 * 0.8 / 850, 0)) %>%
  mutate(pdev = 1 - (1-predictions.16.no.rezone)^n_years) %>%
  mutate(du_allowed = ACRES * M3_MAXDENS) %>%
  mutate(expected_units_if_dev = ifelse((!is.na(du_allowed)) & (expected_units_if_dev > du_allowed),
                                        du_allowed, expected_units_if_dev)) %>%
  mutate(expected_units = pdev * expected_units_if_dev)

```


We compute change to building envelopes under rezoning to figure out expected units if developed

```{r}
sf_sites_inventory <- sf_sites_inventory %>%
  mutate(expected_units_if_dev = ifelse(M3_ZONING != 'No Change', 
                                        Envelope_1000 * 1000 * 0.8 / 850, 0))

# I take the absolute value of M3_CAP because there's a single row
# (viz. row 46952) with a negative M3_CAP value (viz. -0.102), which I believe
# is a typo where someone accidentally placed '-' ahead of 0.102.
sf_sites_inventory <- sf_sites_inventory %>%
  mutate(M3_CAP = abs(M3_CAP)) %>%
  mutate(du_allowed = ACRES * M3_MAXDENS)


sf_sites_inventory <- sf_sites_inventory %>%
  mutate(expected_units_if_dev = ifelse((!is.na(sf_sites_inventory$du_allowed)) & (sf_sites_inventory$expected_units_if_dev > sf_sites_inventory$du_allowed),
                                        du_allowed, expected_units_if_dev))
```

And as we'd expect, the expected units built if developed increases after upzoning
```{r}
## Sanity check

# Envelope
summary(sf_sites_inventory$Envelope_1000)
summary(sf_sites_inventory_norezoning$Envelope_1000)


# E[U|D]
summary(sf_sites_inventory$expected_units_if_dev)
summary(sf_sites_inventory_norezoning$expected_units_if_dev)
```

The final calculation for expected units after rezoning
```{r}
n_years = 5
sf_sites_inventory <- sf_sites_inventory %>%
  mutate(pdev = 1 - (1-predictions.16)^n_years) %>%
  mutate(expected_units = pdev * expected_units_if_dev)

(total_expected_units <- sum(sf_sites_inventory$expected_units, na.rm=T))
```

^ there we go

# Here are the headline takeaways

San Francisco promised a rezoning of ~50k in light of having a shortfall of ~32k units to meet their RHNA + buffer.

With the Map 3 rezoning, this city only produces 
```{r}
no_rezone_expected_units = sum(sf_sites_inventory_norezoning$expected_units, na.rm=T)
(delta_increase <- total_expected_units - no_rezone_expected_units)
```
additional units.

If the city allowed for 5 story buildings in areas that Map 3 zones for fourplexes and density-decontrolled R1, the city would produce in expectation

```{r}
upzone(parisian(sf_sites_inventory_norezoning)) - no_rezone_expected_units
```

more homes.

If the city upzones for skyscrapers everywhere in the site inventory, we only build

```{r}
upzone(legalize_it(sf_sites_inventory_norezoning)) - no_rezone_expected_units
```

units, which is still short


```{r leaf}
library(leaflet)

pal <- colorBin("viridis", bins=c(0, 1, 5, 10, 100, 500))
sf_sites_inventory <- st_as_sf(sf_sites_inventory)
sf_sites_inventory %>%
  dplyr::filter(!is.na(expected_units)) %>%
  dplyr::mutate(block = stringr::str_sub(mapblklot, 1, 4)) %>%
  dplyr::group_by(M3_ZONING, block) %>%
  dplyr::summarise(expected_units = sum(expected_units)) %>%
    leaflet() %>%
    addProviderTiles(providers$CartoDB.Positron, options = providerTileOptions(minZoom = 12, maxZoom = 16)) %>%
      setMaxBounds(lng1 = -122.5149, lat1 = 37.7081, lng2 = -122.3564, lat2 = 37.8324) %>%
    addPolygons(
      fillColor = ~pal(expected_units),
      color = ~pal(expected_units),
      weight = 1,
      label = ~ paste("height:", round(expected_units, 2)),
      # Tooltip text
      labelOptions = labelOptions(
        style = list("font-weight" = "normal", padding = "3px 8px"),
        textsize = "13px",
        direction = "auto"
      )
    ) %>%
    addLegend(
      "bottomright",
      pal = pal,
      values = ~ pal(expected_units),
      title = "Pdev"
    )
```

